<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Posts</title>
    <!--List everything that a user has post-->
    <title>Title</title>
    <script src="../js/jquery.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/jquery-ui.min.css">
    <script src="../js/jquery-ui.min.js"></script>
    <script src="../util/util.js"></script>

    <style>
        ul#my-posts{
            list-style: none;
        }

        body{
            background-color: #ffffff;
            font-family: Roboto, sans-serif;

        }

        .container{
            height: auto;
            width: auto;
            overflow: hidden;
            background-color: #dedede;
        }

        .title{
            color: #384047;
            text-align: center;
            font-size: 25px;
            padding: 0;
        }

        .edit{
            background: #5190af;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
        }

        .delete{
            float: right;
            background: red;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
        }
        .about{
            color: #8a97a0;
            background-color: #e8eeef;
            font-size: 25px;
            margin: 2px;
            padding: 25px;
        }


        #overLay {
            display: block;
            position: fixed;
            width: 100%;
            height: 100%;
            background-color: #707070;
            opacity: 0.7;
            z-index: 9;
            left: 0;
            top: 0;
        }

        #timestamp{

        }

        #about{
            max-width: 300px;
            padding: 10px 20px;
            background: #f4f7f8;
            border-radius: 8px;
            resize: none;
        }

        #price{

        }

        #street{

        }

        #city{

        }

        #zip{

        }

        #state{

        }
        
        .imgclass{
			border: 1px solid #ddd; /* Gray border */
		    border-radius: 4px;  /* Rounded border */
		    padding: 5px; /* Some padding */
		    width: 100px; /* Set a small width */
		    height: 100px; /* Set a small width */
		    display: inline-block;
        }
        
        .divclass{
        	text-align:center;
        	clear:both;
        }

        #edit-button{

            text-transform: uppercase;
            outline: 0;
            background: #5190af;
            width: 100%;
            border: 0;
            padding: 15px;
            color: #FFFFFF;
            font-size: 14px;
            cursor: pointer;
        }

        #edit-form{
            z-index: 10;
            background: #FFFFFF;
            max-width: 360px;
            margin: 0 auto 100px;
            padding: 45px;
            text-align: center;
            box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.2), 0 5px 5px 0 rgba(0, 0, 0, 0.24);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #my-posts-container {
            display: grid;
            grid-gap: 10px;
            background-color: #ffffff;
            color: #444;
        }

        #title-page{
            text-align: center;
            font-size: 2em;
        }

        #title-page:hover{
            color: #52809f;
        }

    </style>

    <script>
        var canDelete = false;
        var postsJSON;
        var canEdit = false;
        var postToBeEdit;
        $(init);

        function init() {

            var userId = getCookie("userId");

            if(!userId){
                window.location.href = '/index.html';
            }

            $("#title-dialog").dialog({
                autoOpen : false, modal : true, show : "blind", hide : "blind"
            });

            $("#title-page").click(function () {
                $("#title-dialog").dialog("open");
            });

            $("#edit-form").hide();
            $("#overLay").hide();

            requestPosts();

        }


        function requestPosts() {
            var userId = getCookie("userId");

            $.get("/get-posts", {userId: userId}, function (result) {
                postsJSON = JSON.parse(result);
                // append to list

                for(let i = 0; i < postsJSON.length; i++){
                    let postJSON = postsJSON[i];
                    if(postJSON !== null){

                        loadPostToList(postsJSON[i]);
                    }
                }
            });
        }

        function requestPost(id) {
            $.get("/get-post", {_id: id}, function (result) {
                let post = JSON.parse(result);
                loadPostToList(post);
            });
        }

        function deletePost(postJSON) {
            if(canDelete) {
                $.post("/delete-post", {json: postJSON}, function (result) {
                    if(result === "OK"){
                        removePostFromView(postJSON._id);
                    }
                });
            }
        }

        function enableEditPost(postJSON) {
            if(canEdit){

                let title = postJSON.title;
                let about = postJSON.about;

                let location = postJSON.location;

                let street = location.street;
                let city = location.city;
                let zip = location.zip;
                let state= location.state;

                let price = postJSON.price;
                let type = postJSON.type;
                let image1 = postJSON.img1;
                let image2 = postJSON.img2;
                let image3 = postJSON.img3;

                $("#title").val(title);
                $("#about").val(about);

                $("#street").val(street);
                $("#city").val(city);
                $("#zip").val(zip);
                $("#state").val(state);

                $("#price").val(price);

                $("#type").val(type);
           		var temp= !document.getElementsByClassName("imgclass").length;
               	if(temp){
	                if(image1!==null){
	                	var elem1 = createImage(image1, 'img1');
	                	$("#image-container").append("<div id='imageContainer1' class='imageButtonOverlay'></div>>");
	                	$("#imageContainer1").append(elem1);
	                }	
	                if(image2!==null){
	                	var elem2 = createImage(image2, 'img2');
	                	$("#image-container").append(elem2);
	
	                }	
	                if(image3!==null){
	                	var elem3 = createImage(image3, 'img3');
	                	$("#image-container").append(elem3);
	                }	
               	}
                postToBeEdit = postJSON;
                enablePopUp();
                enableRemovePopUp();
               
            }
        }


        function createImage(src, id) {
            var anImage = $("<img>");
            anImage.attr('id', id);
            anImage.attr("class", "imgclass");
            anImage.attr("src", src);
            return anImage;
        }

        function editPost() {
            $("#edit-form").hide();
            $("#overLay").hide();
            let userId = getCookie("userId");
            let title = $("#title").val();
            let about = $("#about").val();

            let street = $("#street").val();
            let city = $("#city").val();
            let zip = $("#zip").val();
            let state = $("#state").val();
            let price = $("#price").val();

            let type = $("#type").val();

            var location = {
                "street": street,
                "city": city,
                "zip": zip,
                "state": state
            };

            let image1 = postToBeEdit.img1;
            let image2 = postToBeEdit.img2;
            let image3 = postToBeEdit.img3;

            var newPost = {
                "_id": postToBeEdit._id,
                "userId": userId,
                "title": title,
                "about":about,
                "price":price,
                "type": type,
                "timestamp": new Date().getTime(),
                "location":location,
                "img1": image1,
                "img2": image2,
                "img3": image3
            };

            let oldPost = postToBeEdit;

            let postJSON = {
                oldPost,
                newPost
            };

            $.post("/edit-post", postJSON, function (result) {
                if(result === "OK"){
                    // reload posts after edit
                    //clearAllPosts();
                    //requestPosts();

                    updatePostFromList(newPost);
                }
            });
        }

        function removePostFromView(id) {
            $("#"+id+"div").remove();
        }

        function updatePostFromList(postJSON) {
            let id = postJSON._id;
            removePostFromView(id);
            loadPostToList(postJSON);
            /**
            let id = postJSON._id;

            $("#"+id+"title").text(postJSON.title);
            $("#"+id+"about").text(postJSON.about);*/
        }

        function loadPostToList(postJSON) {

            var div = $("<div></div>");
            div.attr("class", "container");
            div.attr("id", postJSON._id+"div");

            var headline = $("<h></h>");
            headline.attr("class", "title");
            headline.attr("id", postJSON._id+"title");
            headline.text(postJSON.title);

            var paragraph = $("<p></p>");
            paragraph.attr("class", "about");
            paragraph.attr("id", postJSON._id+"about");
            paragraph.text(postJSON.about);

            var deleteButton = $("<button></button>");
            deleteButton.attr("class", "delete");
            deleteButton.on("click", function () {
                canDelete = true;
                deletePost(postJSON);
            });
            deleteButton.text("delete me");

            var editButton = $("<button></button>");

            editButton.attr("class", "edit");
            editButton.text("edit me");
            editButton.on("click", function() {
                canEdit = true;
                enableEditPost(postJSON);
            });

            div.append(headline);
            div.append(paragraph);
            div.append(deleteButton);
            div.append(editButton);

            $("#my-posts-container").append(div);

        }

        /**
         * Enable to hide pop up
         */
        function enablePopUp() {

            $("#edit-form").show();
            $("#overLay").show();

        }

        /**
         * Enable to hide pop up
         */
        function enableRemovePopUp() {
            let overlay = document.getElementById("overLay");
            /**
             * Disable pop up on background
             */
            overlay.onclick = function () {
                $("#edit-form").hide();
                $("#overLay").hide();
            }
        }

        function clearAllPosts() {
            $("#my-posts-container").empty();
        }
    </script>

</head>
<body>

<div style="margin-bottom: 50px;" id="nag-container">

</div>

<h5 id="title-page">My Posts</h5>
<div id="title-dialog" title="More Info">
    <p> Here, you can edit or delete your posts. Its an area to manage what you upload to the site</p>
</div>

<div id="my-posts-container">

</div>



<!--Enable a user to leave popup box when user clicks bg-->
<div id="overLay"></div>



<!--Dynamically hide -->
<div id = "edit-form">
    <label for="title">Product Name</label>
    <input value="none" type="text" name="timestamp" id="timestamp" style="display: none;">
    <input placeholder="title" type="text" id="title" name="title" required>
    <br/>
    <label for="about">Product Description</label><br>
    <textarea id="about" name="about" placeholder="Enter your description" required></textarea>
    <br/>

    <label for="category-selector">Category</label><br>
    <select id="type" name="type" id="category-selector">
        <option value="free-stuff">Free Stuff</option>
        <option value="sports">Sports, Leisure and Games</option>
        <option value="home-and-garden">Home and Garden</option>
        <option value="entertainment">Movies, Books and Music</option>
        <option value="electronics">Electronics</option>
        <option value="fashion">Fashion</option>
        <option value="other">Other</option>
    </select> <br>

    $<input id="price" name="price" type="text" maxlength="20" placeholder="input cost"><br>
    Location<br>
    Street:<input id="street" name="street" type="text" maxlength="20">
    City:<input id="city" name="city" type="text" maxlength="20">
    ZipCode<input id="zip" name="zip" type="text" size="5">
    State: <input id="state" name="state" type="text" size="2">
    Images:<div id="image-container"></div>

    <!--<input type="file" name="imgUploader" id="fileup" multiple required>-->
    <br/>




    <button onclick="editPost()" id="edit-button" type="submit" >Edit</button>
</div>


</body>
</html>