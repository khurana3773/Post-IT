<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <!-- Add Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA12J6t5guwaxlwmAn_XTULgPfJk_n_Qto&callback=googleMaps"></script>
    <script src="js/jquery.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="home.css">
    <script src="util/util.js"></script>
    <script src="util/request.js"></script>
    <script src="util/handler.js"></script>

    <script>
        var dropdownShowing = false;
        var userLoggedIn = false;
        var interval=null;
        var orig_img1=null;
        var id= null;
        var price= "0";
        var maindiv= null;
        var searchbox= false;
        var searchvalue= null;
        var slideIndex=1;
        $(init);
        function init() {

            initCompleteSearchBox();
            initProductSteamLocation();
            initShoppingList();
            initList();
            initSearchBox();

            $("#popup").hide();
            $(".dropdown-content").hide();
            $("#alt-view").hide();
            $("#shopping-list").hide();
            $("#overLay").hide();


            $("#slider").slider({max: 1000, value:0,step:10});
            $("#slider").slider({stop: handleSliderValue});

            $(window).resize();
            //clear featured values
            resetFeature();
            initLogin();
        }

        function initLogin(){

            let userId = getCookie("userId");

            if(userId){
                userLoggedIn = true;
                $("#login").hide();
                $("#sign-out").show();
            }else{
                userLoggedIn = false;
                $("#sign-out").hide();
                $("#login").show();
            }
        }

        function onSignOut() {
            if(userLoggedIn){
                $("#sign-out").hide();
                $("#login").show();
                userLoggedIn = false;
                deleteCookie("userId");
            }

        }

        /**
         * Set event for categories.
         */
       function setCategoriesEvent( idd){
           id = idd;
           searchvalue = null;
       	   searchbox = false;
           searchForCategory();
        }

        /**
         * Resets variable, products list and feature variables
         */
        function resetFeature(){
            $("#products-list").empty();
            $("#flabel1").html("");
            $("#flabel2").html("");
            $("#featured img").removeAttr('src');
            $("#flabel1").removeAttr("class","script1");
            $("#flabel2").removeAttr("class","script2");
            $("#ftitle").removeAttr("class","shadow text2");
            $("#fprice").removeAttr("class","shadow text3");
            $("#ftitle").html("");
            $("#fprice").html("");
            $("#featured").css('background-color','#e0e0dd');
            $("#featured div")[0].style.backgroundColor='#e0e0dd';
            $("#featured div")[1].style.backgroundColor='#e0e0dd';
            $("#featured div")[0].style.display='block';
            $("#featured div")[1].style.width='50%';
        }

        /**
         * Gets products with category from database.
         * Update product stream
         */
        function searchForCategory() {
            id = $(this).attr('id');
            $("#products-list").empty();
            resetFeature();
            $.ajax({
                url: ("http://" + $(location).attr('host')) + "/category",
                data: "type=" + id + ",price:" + price,
                type: 'GET',
                contentType: 'application/json'
                ,
                success: function (result) {
                    if ($.trim(result)) {
                        postsJSON = JSON.parse(result);
                        for (let i = 0; i < postsJSON.length; i++) {
                            let postJSON = postsJSON[i];
                            if (postJSON !== null) {
                                if(i===0){
                                    featurefill(postsJSON[i]);
                                }
                                loadPostToList(postsJSON[i]);
                            }
                        }
                    }
                }
            });
        }

        //Creates elements and set their values and styling
        function loadPostToList(postJSON) {
            	var li = $("<li></li>");

                var div1 = $("<div></div>");
                div1.attr("id",postJSON._id +"detail");
                div1.css("display","block");


                var d = postJSON._id + "div";

             //   var div = $("<div onmouseover=\"over(this)\" onmouseout=\"out(this)\" )\"></div>");
                var div = $("<div onmouseover=\"over(this)\" onmouseout=\"out(this)\" )\"></div>");

                div.draggable({helper: 'clone'});
                div.attr("class", "product");
                div.attr("id", postJSON._id + "div");
              //  $("#products-list").on("DOMNodeInserted", ".product", function() { $(this).draggable(); });

                var title = $("<p></p>");
                title.attr("id", postJSON._id + "title");
                title.addClass("productTitle");
                title.text(postJSON.title);
                title.css("text-align","center");
                title.css("overflow","hidden");
                title.css("white-space","nowrap");
                title.css("text-overflow", "ellipsis");

                var img_1 = $("<img></img>");
                img_1.attr("src",postJSON.img1);
                img_1.attr("class","pic");
                img_1.height("100").width("80%");
                img_1.attr("id","img1");

                img_1.on("error", function(){
                	if(this.src !== './img/NoImage.png' || this.src !== 'null') this.src = './img/NoImage.png';
                });

                var img_2 = $("<img></img>");
                img_2.attr("src",postJSON.img2);
                img_2.height("100").width("80%");
                img_2.attr("class","pic");
                img_2.css("display","none");

                var img_3 = $("<img></img>");
                img_3.attr("src",postJSON.img3);
                img_3.height("100").width("80%");
                img_3.attr("class","pic");
                img_3.css("display","none");

                var desc = $("<p></p>");
                desc.attr("id", postJSON._id + "desc");
                desc.text(postJSON.about);
                desc.css("text-align","center");
                desc.css("overflow","hidden");
                desc.css("white-space","nowrap");
                desc.css("text-overflow", "ellipsis");

                var price = $("<p></p>");
                price.attr("id", postJSON._id + "price");
                price.text("$ " +postJSON.price);
                price.css("text-align","center");

                var div2 = $("<div></div>");
                div2.css("text-align","center");

                var clickME = $("<button onclick=\"onPop()\"></button>");
                clickME.text("Click Me for more!");
                clickME.css("text-align","center");
                clickME.css("visibility","hidden");

                var loc =$("<a></a>");
                loc.text("Location");
                loc.attr("id", postJSON._id + "loc");
                loc.attr("href","");
                loc.attr("target","_blank");
                loc.css("text-align","left");
                loc.css("display","none");
                loc.css("font-weight","bold");
				getLatitudeLongitude(postJSON.location,postJSON._id + "loc" );

                var contact = $("<a></a>");
                loc.text("Contact");
                contact.attr("id", postJSON.userId);
                contact.attr("subject", "Re:"+postJSON.title+"("+postJSON.type+")");
                contact.css("text-align","right");
                contact.css("display","none");

				li.append(div);
                div.append(title);
				div.append(img_1);
				if ($(img_2).src!== "" ||$(img_2).src!== "null"||$(img_2).src!== null)
               		div.append(img_2);
				if ($(img_3).src!== "" ||$(img_3).src!== "null"||$(img_3).src!== null)
               		div.append(img_3);

                div.append(price);
                div.append(div1);
                div1.append(desc);
                div1.append(div2);
                div2.append(clickME);
                div1.append(loc);
                div1.append(contact);

                $("#products-list").append(li);
         }
        
        // To fill the Feature content with first json object if any
        function featurefill(postJSON) {

            if (postJSON.img1.length > 2) {
                $("#featured img").attr("src", postJSON.img1);

            } else {
                $("#featured div")[0].style.display="none";
                $("#featured div")[1].style.width="100%";
            }
            $("#flabel1").html("Featuring");
            $("#flabel2").html("Browse below for more!");
            $("#ftitle").html(postJSON.title);
            $("#fprice").html("For only $"+ postJSON.price);

            $("#flabel1").attr("class","script1");
            $("#flabel2").attr("class","script2");
            $("#ftitle").attr("class","shadow text2");
            $("#fprice").attr("class","shadow text3");
            $("#featured").css('background-color',' #52a5c3');
            $("#featured div")[0].style.backgroundColor='#52a5c3';
            $("#featured div")[1].style.backgroundColor=' #52a5c3';
        }

        function displayNextImage() {
                x = (x === images.length - 1) ? 0 : x + 1;
                document.getElementById("img").src = images[x];
        }

        function displayPreviousImage() {
                x = (x <= 0) ? images.length - 1 : x - 1;
                document.getElementById("img").src = images[x];
        }

        function startTimer() {
                setInterval(displayNextImage, 3000);
        }

            var images = [], x = -1;
            images[0] = "image1.jpg";
            images[1] = "image2.jpg";
            images[2] = "image3.jpg";

        // Search bar event listener once return/enter key pressed
        function initSearchBox() {
            $("#search-bar").keyup(function(event){
                if(event.keyCode === 13){
                    //TODO: Enable search from database
                    let searchValue = $("#search-bar").val();

                    if(!searchValue){
                        // shake it
                        $("#search-bar").effect("shake", {times: 4, distance: 10}, 1000);
                        return;
                    }
                    else{
                    	//clear search bar value
                    	$("#search-bar").val("");
                    	price= "0";
                    	resetFeature();
                    	requestProduct(searchValue);
                    }
                }
            });
        }

        //Updates product view once return/enter key pressed on search bar
        function requestProduct(searchValue) {
        	searchvalue = searchValue;
        	searchbox = true;
            id = $(this).attr('id');
            $("#products-list").empty();
            resetFeature();
            $.ajax({
                url: ("http://" + $(location).attr('host')) + "/search",
                data: "search=" + searchValue + ",price:" + price,
                type: 'GET',
                contentType: 'application/json'
                ,
                success: function (result) {
                    if ($.trim(result)) {
                        postsJSON = JSON.parse(result);
                        for (let i = 0; i < postsJSON.length; i++) {
                            let postJSON = postsJSON[i];
                            if (postJSON !== null) {
                                if(i===0){
                                    featurefill(postsJSON[i]);
                                }
                                loadPostToList(postsJSON[i]);
                            }
                        }
                    }
                }
            });

        }

        function initShoppingList(){

            let userId = getCookie("userId");

            var dataPost={
                "userId" : userId
            }



            $("#shopping-list").draggable();
            $("#shopping-list").resizable({
                handles: 'n, e, s, w'
            });
            $("#dragTest").draggable({  revert: "invalid" });

            $("#shopping-list").droppable(
                {
                    over: dragObject
                }
            );

            $("#deleteProductBtn").bind("click", function () {
               var deleteWishListData=[];

                $(".yellow").each(function (index) {
                    let eachData = {};
                    eachData['postId'] = $(this).data("dbId");

                    deleteWishListData.push(eachData);
                    $.ajax({
                        url: ("http://" + $(location).attr('host')) + "/delete-post-wishlist",
                        data: eachData ,
                        type: 'POST',
                        success: function (result) {
                            console.log("deleted from wishlist");
                        }
                    });
                })
                $(".yellow").remove()

               //console.log(JSON.stringify(deleteWishListData));

//
//                $.ajax({
//                    url: ("http://" + $(location).attr('host')) + "/delete-post-wishlist",
//                    data: deleteWishListData,
//                    type: 'POST',
//                    success: function (result) {
//                        console.log("deleted from wishlist");
//                    }
//                });
//                 $(".yellow").remove()




            });

            $.ajax({
                url: ("http://" + $(location).attr('host')) + "/get-wishlist-posts",
                data: dataPost ,
                type: 'GET',
                contentType: 'application/json'
                ,
                success: function (result) {
                    if ($.trim(result)) {
                        console.log("inside wishlist: " + result);
                        createListView(JSON.parse(result));

                    }
                }
            });


        }

        function initList() {
            $(".product").draggable({ revert: 'invalid' });

            $(".product").css("zIndex", 2);
        }

        /**
         * Handles what happens when user decides to add product to list.
         * Wish List/Shopping List UI is a list view. Is link to product.
         */
        function dragObject(event, ui){
            //$("#product").remove();

            wishListAllItems=[];
            let product = ui.draggable;
            $(product).clone(true);
            let productTitle = $(product).children('.productTitle');
//            alert(productTitle.text())
            var wishListItem = {};
            wishListItem['title'] = productTitle.text();


            let id = $(ui.draggable).attr("id");

            id = id.substring(0,id.length-3)
            wishListItem['postId']=id;
           // alert(id.substring(0,id.length-3));


            $.ajax({
                url: ("http://" + $(location).attr('host')) + "/add-post-wishlist",
                data: wishListItem ,
                type: 'POST'
                ,
                success: function (result) {

                    responseJSON = JSON.parse(result);
                    if(responseJSON.alreadyExists=='yes')
                    {
                        alert("exists already");

                    }else
                    {
                        wishListAllItems.push(wishListItem);
                        createListView(wishListAllItems);
                    }
                }
            });





            //todo : intimate customer about item already being in wishlist
//            $.post( '/add-post-wishlist', wishListItem,function(data) {
//                    alert("finished call");
//                    alert(JSON.stringify(data));
//                    var exists = data.alreadyExist;
//                    if(exist.toString().trim()==='yes'.trim())
//                    {
//                        wishListAllItems.push(wishListItem);
//                        createListView(wishListAllItems);
//                    }
//                    else
//                    {
//                        alert("else condition");
//                    }
//
//                } , 'application/json'
//            );


        }


        function createListView(productJSON) {
            //var data = productJSON;
            $.each(productJSON, function(i, item) {

                let title = $("<p></p>");
                title.text(item['title']);

                let anItem = $("<li></li>");
                anItem.bind("click", function(){
                    $(this).toggleClass('yellow');
                    //console.log($(this).data("dbId"));
                });

                anItem.data("dbId",String(item['postId']));

                anItem.append(title);
                $("#list").append(anItem);
            });
        }

        //todo: use this method instead of calling all functionality in dragobject
        /**
         * Add product id into user's shopping list
         * MongoDB
         */
        function appendProduct(productId) {


        }

        /**
         * Filters products currently on stream by miles
         */
        function handleSliderValue(event, ui) {
            price = ui.value;
            $( "#p-distance" ).text( "Min Price $ "+ui.value );
            if (!searchbox){
            	searchForCategory();
            }else{
            	requestProduct(searchvalue);
            }
        }

        // Will dynamically generate search bar population with ajax from our database
        function initCompleteSearchBox(){
            $("#search-bar").keyup(function () {
                let val = $("#search-bar").val();
                requestAutoComplete(val, setCompleteSearchBox);
            });
        }

        // search input is an array
        function setCompleteSearchBox(searchInput){
            $("#search-bar").autocomplete({
                source: searchInput
            });
        }

        /**
         * Add productJSON to product stream
         */
        function appendToProductStream(productJSON){
            var unorderList = document.getElementById("products-list");
            // append to list
            // tester
            alert(productJSON.location);
        }
        /**
         * Dynamically centers product streams
         */
        function initProductSteamLocation() {
            $(window).resize(function(){
                $('#products').css({
                    position:'absolute',
                    left: ($(window).width() - $('#products').outerWidth())/2,
                    top: 70
                });
            });
        }

        function fetchPopupInfo(){
            requestProductPopup('tester', onPopUp);
        }
        /**
         * Enables pop up on background
         */
        function onPopUp(popupJSON) {
            $("#popup").toggle();
            $("#overLay").toggle();
            let addressJSON = popupJSON.address;
            displayLocation(addressJSON);
            // should be able to undo pop up
            enableRemovePopUp();
        }
        /**
         * Enable to hide pop up
         */
        function enableRemovePopUp() {
            let overlay = document.getElementById("overLay");
            /**
             * Disable pop up on background
             */
            overlay.onclick = function () {
                $("#popup").toggle();
                $("#overLay").toggle();
            }
        }

        function dropdownAnimateDown() {
            if(dropdownShowing){
                $('.dropdown-content').slideUp("medium");

            }else{
                $('.dropdown-content').slideDown("medium");
            }

            dropdownShowing = !dropdownShowing;
        }


        function loadToPopUp(productJSON) {

        }

        function loadNagBar() {

        }

        /**
        * Allows drop down /expansion effect
        * once user hovers on a product
        */
        function over(e) {

              maindiv=e;
        	  orig_img1	=null;
        	  //var d= document.getElementById(e.id).getElementsByTagName("div")[0];
              //d.style.display="block";
              var images = [],
              x = 0;
              var buttonclick= document.getElementById(e.id).getElementsByTagName("button")[0];
              buttonclick.style.visibility="visible";
              var image= document.getElementById(e.id).getElementsByClassName("pic");
              $.each( image,function(index, value){
            	  if( value.currentSrc!=="" && value.currentSrc!== null  && value.currentSrc!== "null"){
            		  images[x]=value.src;
            		  x++;
            	  }
              });

              var $img = $("#"+e.id+' #img1'), i = 0, speed = 200;
              orig_img1=images[0];
              // Only if there are more than 1 images, allow pics to keep changing in every 3secs.
			  if(images.length>1)
	              interval=window.setInterval(function() {
	                $img.fadeOut(speed, function() {
	                  $img.attr("src", images[(++i % images.length)]);
	                  $img.fadeIn(speed);
	                });
	              }, 1500);
        	}
        /**
         * Allows unsettin of intervals if set for the product.
         * and undo the expansion effect
         */
        function out(e) {
            var buttonclick= document.getElementById(e.id).getElementsByTagName("button")[0];
            buttonclick.style.visibility="hidden";
        	if (interval!==null){
	        	clearInterval(interval);
	        	interval=null;
                var $img = $("#"+e.id+' #img1');
                $img.attr("src", orig_img1);

        	}
            orig_img1=null;
            maindiv=null;
      	}

        /**
         * Allows complete view of a product as poped-up alternative view
         */
        function onPop() {

            $("#alt-view").toggle();
            $("#overLay").toggle();
            var d= document.getElementById(maindiv.id);
            var p=d.getElementsByTagName("p");
            var div1=d.getElementsByTagName("div")[0];
            var loc= div1.getElementsByTagName("a")[0];
            var contact= div1.getElementsByTagName("a")[1];
            var image= d.getElementsByClassName("pic");
            $(".mypics").remove();
            if(orig_img1!==null)
                out(maindiv);
            $.each( image,function(index, value){
                if( value.currentSrc!=="" && value.currentSrc!== null  && value.currentSrc!== "null"){
                    var img = $("<img></img>");
                    img.attr("src",value.src);
                    img.height("300px").width("300px");
                    img.css("margin","auto");
                    img.attr("class","mypics");
                    $("#first").before(img);
                    x++;
                }
            });
            slideIndex = 1;
            showSigns(slideIndex);
            $("#poptitle").text(p[0].innerHTML);
            $("#popprice").text("Price: "+ p[1].innerHTML);
            $("#popdesc").text(p[2].innerHTML);
            if(userLoggedIn) {
                $(".validuserenable").css("visibility","visible");
                $("#poploc").attr("href", loc.href);
                $.ajax({
                    url: ("http://" + $(location).attr('host')) + "/email",
                    data: "id=" + contact.id,
                    type: 'GET',
                    contentType: 'application/text'
                    ,
                    success: function (result) {
                        if ($.trim(result)) {
                            $("#popcontct").attr("href", "mailto:" + result);

                        }
                    }
                });
            }
            else{
            	$(".validuserenable").css("visibility","hidden");
            }
            // should be able to undo pop up

            removePop();
        }

        /**
         * Enable to hide pop up
         */
        function removePop() {
            let overlay = document.getElementById("overLay");
            /**
             * Disable pop up on background
             */

            overlay.onclick = function () {
                $("#alt-view").toggle();
                $("#overLay").toggle();
            }
        }

        function plusDivs(n) {
            showSigns(slideIndex += n);
        }

        function showSigns(n) {
            var i;
            var x = document.getElementsByClassName("mypics");
            if (n > x.length) {slideIndex = 1}
            if (n < 1) {slideIndex = x.length}
            for (i = 0; i < x.length; i++) {
                x[i].style.display = "none";
            }
            x[slideIndex-1].style.display = "block";
        }




</script>

</head>
<body>



<div class="mainBody">
    <div id="nav">
        <div id="nav-wrapper">
            <ul>
                <button onclick="dropdownAnimateDown();" class="nag-button">&#9776;</button>

                <li><a href="index.html">Home</a></li>
                <li><a href="/create-post">Post Something</a></li>
                <!--Button to display shopping list -->
                <button onclick="$('#shopping-list').toggle();" class="nag-button">Wish List</button>
                <!-- Search Bar -->
                <input id="search-bar" name="search" type="text" placeholder="What are you looking for?">

                <li id="login"><a href="login.html">Login</a></li>
                <li id="sign-out"><a onclick="onSignOut()">Sign Out</a></li>
                <li id="dragTest">Drag me</li>
            </ul>
        </div>
    </div>

    <div class="dropdown-content">
        <ul id="dropdown-list">
            <!--<li><a href="profile.html"> Profile </a></li>
            <li><a href="#"> Settings </a></li> -->
            <li><a href="posts/my-posts.html"> My Posts </a></li>
            <li><a href="about.html"> Want a job or contact us?</a></li>
        </ul>
    </div>


    <!-- Sidebar -->
    <div id="side-bar">
        <h3 class="categories">Categories</h3>
        <ul id="menu">
            <li><div class="category" id="rent" onclick="setCategoriesEvent('rent')"><span class="ui-icon ui-icon-tag"></span>Rent</div></li>
            <li><div class="category" id="free-stuff" onclick="setCategoriesEvent('free-stuff')"><span class="ui-icon ui-icon-tag"></span>Free Stuff</div></li>
            <li><div class="category" id="sports" onclick="setCategoriesEvent('sports')"><span class="ui-icon ui-icon-tag"></span>Sports, Leisure and Games</div></li>
            <li><div class="category" id="home-and-garden" onclick="setCategoriesEvent('home-and-garden')"><span class="ui-icon ui-icon-tag"></span>Home and Garden</div></li>
            <li><div class="category" id="entertainment" onclick="setCategoriesEvent('entertainment')"><span class="ui-icon ui-icon-tag"></span>Movies, Books and Music</div></li>
            <li><div class="category" id="electronics" onclick="setCategoriesEvent('electronics')"><span class="ui-icon ui-icon-tag"></span>Electronics</div></li>
            <li><div class="category" id="jobs" onclick="setCategoriesEvent('jobs')"><span class="ui-icon ui-icon-tag"></span>Jobs</div></li>
            <li><div class="category" id="fashion" onclick="setCategoriesEvent('fashion')"><span class="ui-icon ui-icon-tag"></span>Fashion</div></li>
            <li><div class="category" id="other" onclick="setCategoriesEvent('other')"><span class="ui-icon ui-icon-tag"></span>Other</div></li>
        </ul>


        <p id="p-distance" style="font-weight: bolder;font-size: 1.17em;">Min Price $ 0 </p>
        <div id="slider"></div>

        <div id="slider-wrapper-label ">
            <label for="slider">0</label>
            <label for="slider" style="margin-left: 10em">1000+</label>
        </div>


    </div>

    <!--Dynamically stream products here by category-->
    <div id="products">
        <div id ="featured">
            <div style="float:left">
                <img></img>

            </div>
            <div style="overflow: hidden">
                <p id="flabel1"></p>
                <p id ="ftitle"></p>
                <p id="fprice"></p>
                <br>
                <p id="flabel2"></p>
            </div>

        </div>
        <ul id="products-list">

        </ul>
    </div>

    <!--Enable a user to leave popup box when user clicks bg-->
    <div id="overLay" onclick="$('#overLay').hide(); $('#alt-view').hide();"></div>

    <!--Dynamically hide -->
    <div id = "alt-view">


            <h3 id="poptitle" style="text-align: center">Product Name :</h3>

            <div  style="text-align: center; display: block;">
                <div class="validuserenable" style="float:left;text-align:center;width:33%;visibility: hidden">
                    <h3 style="text-align: left"><a id="poploc" target="_blank" >Location</a></h3>
                </div>
                <div style="float:left;text-align:center;width:33%"><h3 id="popprice" style="font-weight: bold">Price(USD) :</h3></div>
                <div  class="validuserenable" style="float:left;text-align:center;width:33%;visibility: hidden">
                    <h3 style="text-align: right"><a id="popcontct">Contact</a></h3>
                </div>
            </div>

            <div id="designDiv">
                <p id="popdesc" style="text-align: center"><p>
            </div>
            <div>
                <button id ="first" style="margin-right: 100px;" onclick="plusDivs(-1)">&#10094;</button>
                <button style="margin-left: 100px;" onclick="plusDivs(1)">&#10095;</button>
            </div>

    </div>

    <!-- Contains references to shopping list-->
    <div id="shopping-list">
        <p>Shopping List</p>
        <ul style="padding: 0px;" id="list" data-role="listview">

        </ul>

        <button id='deleteProductBtn'>Delete</button>
    </div>
</div>

</body>
</html>
