<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <!-- Add Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA12J6t5guwaxlwmAn_XTULgPfJk_n_Qto&callback=googleMaps"></script>
    <script src="js/jquery.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="home.css">
    <script src="util/util.js"></script>
    <script src="util/request.js"></script>
    <script src="util/handler.js"></script>

    <script>
        var dropdownShowing = false;
        var userLoggedIn = false;
        var interval=null;
        var orig_img1=null;

        $(init);
        function init() {

            initCompleteSearchBox();
            initProductSteamLocation();
            initShoppingList();
            initList();
            initSearchBox();
            setCategoriesEvent();

            $("#popup").hide();
            $(".dropdown-content").hide();

            $("#shopping-list").hide();
            $("#overLay").hide();


            $("#slider").slider({max: 50});
            $("#slider").slider({change: handleSliderValue});


            $(window).resize();
            
            initLogin();
        }

        function initLogin(){

            let userId = getCookie("userId");

            if(userId){
                userLoggedIn = true;
                $("#login").hide();
                $("#sign-out").show();
            }else{
                userLoggedIn = false;
                $("#sign-out").hide();
                $("#login").show();
            }
        }

        function onSignOut() {
            if(userLoggedIn){
                $("#sign-out").hide();
                $("#login").show();
                userLoggedIn = false;
                deleteCookie("userId");
            }

        }
        /**
         * Set event for categories.
         */
        function setCategoriesEvent(){
            $(".category").click(searchForCategory);
        }
        /**
         * Gets products with category from database.
         * Update product stream
         */
        function searchForCategory() {
            var id = $(this).attr('id');
            $("#products-list").empty();
            $.ajax({url: ("http://"+$(location).attr('host'))+"/category", data: "type="+id,type:'GET',contentType: 'application/json' 
            	,success: function(result){
            	postsJSON = JSON.parse(result);
            	console.log("starting");
            	console.log(postsJSON);
            	 for (let i = 0; i < postsJSON.length; i++) {
                     let postJSON = postsJSON[i];
                     if (postJSON !== null) {
                    	 console.log("inside loop "+i);

                         loadPostToList(postsJSON[i]);
                         console.log("after loop "+i);
                     }
                 }
             	}
            });
            
            //Creates elements and set their values and styling
            function loadPostToList(postJSON) {

            	var li = $("<li></li>");
            	
                var div1 = $("<div></div>");
                div1.attr("id",postJSON._id +"detail");
                div1.css("display","none");
                var d = postJSON._id + "div";
 
                var div0 = $("<div></div>");
                div0.attr("id", postJSON._id + "div0");
                div0.css("display","block");
                                
                var div = $("<div onmouseover=\"over(this)\" onmouseout=\"out(this)\"></div>");
                div.attr("class", "product");
                div.attr("id", postJSON._id + "div");        

                
                var title = $("<p></p>");
                title.attr("id", postJSON._id + "title");
                title.text(postJSON.title);
                title.css("text-align","center");
				
                var img_1 = $("<img></img>");
                img_1.attr("src",postJSON.img1);
                img_1.attr("class","pic");
                img_1.height("100").width("100");
                img_1.attr("id","img1");
                
                img_1.on("error", function(){
                	if(this.src !== './img/NoImage.png' || this.src !== 'null') this.src = './img/NoImage.png';
                });               
                
                var img_2 = $("<img></img>");
                img_2.attr("src",postJSON.img2);
                img_2.height("100").width("100");
                img_2.attr("class","pic");
                img_2.css("display","none");
                
                var img_3 = $("<img></img>");
                img_3.attr("src",postJSON.img3);
                img_3.height("100").width("100");
                img_3.attr("class","pic");
                img_3.css("display","none");
                
                var desc = $("<p></p>");
                desc.attr("id", postJSON._id + "desc");
                desc.text(postJSON.about);
                desc.css("text-align","center");
                
                var price = $("<p></p>");
                price.attr("id", postJSON._id + "price");
                price.text("$ " +postJSON.price);
                price.css("text-align","center");
                
                var loc =$("<a></a>");
                loc.text("Location");
                loc.attr("id", postJSON._id + "loc");
                loc.attr("href","");
                loc.attr("target","_blank");
                loc.css("text-align","center");
                loc.css("display","block");
                loc.css("font-weight","bold");
				getLatitudeLongitude(postJSON.location,postJSON._id + "loc" );

				li.append(div);
                div.append(title);
				div.append(img_1);
				console.log($(img_2).src);
				if ($(img_2).src!== "" ||$(img_2).src!== "null"||$(img_2).src!== null)
               		div.append(img_2);
				if ($(img_3).src!== "" ||$(img_3).src!== "null"||$(img_3).src!== null)
               		div.append(img_3);
                div.append(price);
                div.append(div1);
                div1.append(desc);
                div1.append(loc);
                div.append(div1);                
                $("#products-list").append(li);
            }
        }
        function displayNextImage() {
                x = (x === images.length - 1) ? 0 : x + 1;
                document.getElementById("img").src = images[x];
            }

            function displayPreviousImage() {
                x = (x <= 0) ? images.length - 1 : x - 1;
                document.getElementById("img").src = images[x];
            }

            function startTimer() {
                setInterval(displayNextImage, 3000);
            }

            var images = [], x = -1;
            images[0] = "image1.jpg";
            images[1] = "image2.jpg";
            images[2] = "image3.jpg";    

        function initSearchBox() {
            $("#search-bar").keyup(function(event){
                if(event.keyCode === 13){
                    //TODO: Enable search from database
                    let searchValue = $("#search-bar").val();

                    if(!searchValue){
                        // shake it
                        $("#search-bar").effect("shake", {times: 4, distance: 10}, 1000);
                        return;
                    }

                    requestProduct(searchValue, appendToProductStream);
                    //clear search bar value
                    $("#search-bar").val("");
                }
            });
        }
        function initShoppingList(){

            $("#shopping-list").draggable();
            $("#shopping-list").resizable({
                handles: 'n, e, s, w'
            });
            $("#shopping-list").droppable(
                {
                    accept: '.product',
                    over: dragObject
                }
            );

            $("#deleteProductBtn").bind("click", function () {
                $(".yellow").remove();
            });

        }
        function initList() {
            $(".product").draggable({ revert: 'invalid' });

            $(".product").css("zIndex", 2);
        }
        /**
         * Handles what happens when user decides to add product to list.
         * Wish List/Shopping List UI is a list view. Is link to product.
         */
        function dragObject(event, ui){
            //$("#product").remove();

            let product = ui.draggable;

            let id = $(ui.draggable).attr("id");
            alert(id);

            ui.draggable.remove();

            createListView(null);
        }

        function createListView(productJSON) {
            let title = $("<p>Example</p>");

            let anItem = $("<li></li>");
            anItem.bind("click", function(){
                $(this).toggleClass('yellow');
            });

            anItem.append(title);
            $("#list").append(anItem);

        }
        /**
         * Add product id into user's shopping list
         * MongoDB
         */
        function appendProduct(productId) {

        }
        /**
         * Filters products currently on stream by miles
         */
        function handleSliderValue(event, ui) {
            var miles = ui.value;
            $.get('/slider', {miles: miles}, function (result) {

            });
        }
        // Will dynamically generate search bar population with ajax from our database
        function initCompleteSearchBox(){
            $("#search-bar").keyup(function () {
                let val = $("#search-bar").val();
                requestAutoComplete(val, setCompleteSearchBox);
            });
        }
        // search input is an array
        function setCompleteSearchBox(searchInput){
            $("#search-bar").autocomplete({
                source: searchInput
            });
        }

        /**
         * Add productJSON to product stream
         */
        function appendToProductStream(productJSON){
            var unorderList = document.getElementById("products-list");
            // append to list
            // tester
            alert(productJSON.location);
        }
        /**
         * Dynamically centers product streams
         */
        function initProductSteamLocation() {
            $(window).resize(function(){
                $('#products').css({
                    position:'absolute',
                    left: ($(window).width() - $('#products').outerWidth())/2,
                    top: 70
                });
            });
        }

        function fetchPopupInfo(){
            requestProductPopup('tester', onPopUp);
        }
        /**
         * Enables pop up on background
         */
        function onPopUp(popupJSON) {
            $("#popup").toggle();
            $("#overLay").toggle();
            let addressJSON = popupJSON.address;
            displayLocation(addressJSON);
            // should be able to undo pop up
            enableRemovePopUp();
        }
        /**
         * Enable to hide pop up
         */
        function enableRemovePopUp() {
            let overlay = document.getElementById("overLay");
            /**
             * Disable pop up on background
             */
            overlay.onclick = function () {
                $("#popup").toggle();
                $("#overLay").toggle();
            }
        }

        function dropdownAnimateDown() {
            if(dropdownShowing){
                $('.dropdown-content').slideUp("medium");

            }else{
                $('.dropdown-content').slideDown("medium");
            }

            dropdownShowing = !dropdownShowing;
        }


/*        function appendToStream(productJSON) {
            let title = productJSON.title;
            let about = productJSON.about;
            let productId = productJSON._id;
            let location = productJSON.location;

            let li = $("<li></li>");
            let div = $("<div class='product' id=' \"div\"+productId'></div>");

            div.bind("click", loadToPopUp(productJSON));

            let pTitle = $("<p></p>").text(title);

            div.append(pTitle);
            li.append(div);

            $("#products").append(li);
        }*/
        
        function loadToPopUp(productJSON) {
            
        }

        function loadNagBar() {

        }

        /**
        * Allows drop down /expansion effect
        * once user hovers on a product
        */   
        
        function over(e) {
        	  orig_img1	=null;
        	  var d= document.getElementById(e.id).getElementsByTagName("div")[0];
              d.style.display="block";
              var images = [],
              x = 0;
              var image= document.getElementById(e.id).getElementsByClassName("pic");
              $.each( image,function(index, value){
            	  if( value.currentSrc!=="" && value.currentSrc!== null  && value.currentSrc!== "null"){ 
            		  images[x]=value.src;
            		  x++;
            	  }
              });

              var $img = $("#"+e.id+' #img1'), i = 0, speed = 200;
              orig_img1=images[0];
              console.log();
              // Only if there are more than 1 images, allow pics to keep changing in every 3secs. 
			  if(images.length>1)
	              interval=window.setInterval(function() {
	                $img.fadeOut(speed, function() {
	                  $img.attr("src", images[(++i % images.length)]);
	                  $img.fadeIn(speed);
	                });
	              }, 3000);
			  
        	}
        /**
         * Allows unsettin of intervals if set for the product.
         * and undo the expansion effect
         */  
        function out(e) {
        	if (interval!==null){
	        	clearInterval(interval);	
	        	interval=null;
        	}	
      	  	var d= document.getElementById(e.id).getElementsByTagName("div")[0];
      	  	d.style.display="none";
      	    var $img = $("#"+e.id+' #img1');
      	    $img.attr("src", orig_img1);
      	    orig_img1=null;
      	}
        
</script>

</head>
<body>

<div class="mainBody">
    <div id="nav">
        <div id="nav-wrapper">
            <ul>
                <button onclick="dropdownAnimateDown();" class="nag-button">&#9776;</button>

                <li><a href="index.html">Home</a></li>
                <li><a href="/create-post">Post Something</a></li>
                <!--Button to display shopping list -->
                <button onclick="$('#shopping-list').toggle();" class="nag-button">Wish List</button>
                <!-- Search Bar -->
                <input id="search-bar" name="search" type="text" placeholder="What are you looking for?">

                <li id="login"><a href="login.html">Login</a></li>
                <li id="sign-out"><a onclick="onSignOut()">Sign Out</a></li>
            </ul>
        </div>
    </div>

    <div class="dropdown-content">
        <ul id="dropdown-list">
            <li><a href="profile.html"> Profile </a></li>
            <li><a href="#"> Settings </a></li>
            <li><a href="posts/my-posts.html"> My Posts </a></li>
            <li><a href="about.html"> Want a job or contact us?</a></li>
        </ul>
    </div>


    <!-- Sidebar -->
    <div id="side-bar">
        <h3 class="categories">Categories</h3>
        <ul id="menu">
            <li><div class="category" id="rent"><span class="ui-icon ui-icon-tag"></span>Rent</div></li>
            <li><div class="category" id="free-stuff"><span class="ui-icon ui-icon-tag"></span>Free Stuff</div></li>
            <li><div class="category" id="sports"><span class="ui-icon ui-icon-tag"></span>Sports, Leisure and Games</div></li>
            <li><div class="category" id="home-and-garden"><span class="ui-icon ui-icon-tag"></span>Home and Garden</div></li>
            <li><div class="category" id="entertainment"><span class="ui-icon ui-icon-tag"></span>Movies, Books and Music</div></li>
            <li><div class="category" id="electronics"><span class="ui-icon ui-icon-tag"></span>Electronics</div></li>
            <li><div class="category" id="jobs"><span class="ui-icon ui-icon-tag"></span>Jobs</div></li>
            <li><div class="category" id="fashion"><span class="ui-icon ui-icon-tag"></span>Fashion</div></li>
            <li><div class="category" id="other"><span class="ui-icon ui-icon-tag"></span>Other</div></li>
        </ul>


        <p id="p-distance">Distance in Miles</p>
        <div id="slider"></div>

        <div id="slider-wrapper-label ">
            <label for="slider">1</label>
            <label for="slider" style="margin-left: 10em">50+ </label>
        </div>
    </div>

    <!--Dynamically stream products here by category-->
    <div id="products">
        <ul id="products-list">
                        
        </ul>
    </div>
    
    <!-- Contains references to shopping list-->
    <div id="shopping-list">
        <p>Shopping List</p>
        <ul style="padding: 0px;" id="list"data-role="listview">

        </ul>

        <button id='deleteProductBtn'>Delete</button>
    </div>
</div>

</body>
</html>