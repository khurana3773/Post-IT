<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <!-- Add Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA12J6t5guwaxlwmAn_XTULgPfJk_n_Qto&callback=googleMaps"></script>
    <script src="js/jquery.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="home.css">
    <script src="util/util.js"></script>
    <script src="util/request.js"></script>
    <script src="util/handler.js"></script>
    <script type="text/javascript">
        var dropdownShowing = false;
        var userLoggedIn = false;

        $(init);
        function init() {
            initCompleteSearchBox();
            initProductSteamLocation();
            initShoppingList();
            initList();
            initSearchBox();
            setCategoriesEvent();

            $("#popup").hide();
            $(".dropdown-content").hide();

            $("#shopping-list").hide();
            $("#overLay").hide();

            $("#slider").slider({max: 50});
            $("#slider").slider({change: handleSliderValue});


            $(window).resize();

            initLogin();
        }

        function initLogin(){
            let searchParams = new URLSearchParams(window.location.search);
            let userId = searchParams.get("userId");

            if(userId){
                userLoggedIn = true;
                setCookieUserId(userId);
                $("#login").hide();
                $("#sign-out").show();
            }else{
                userLoggedIn = false;
                $("#sign-out").hide();
                $("#login").show();
            }
        }

        function onSignOut() {
            if(!userLoggedIn){
                $("#sign-out").hide();
                $("#login").show();

                userLoggedIn = false;
            }

        }
        /**
         * Set event for categories.
         */
        function setCategoriesEvent(){
            $(".category").click(searchForCategory);
        }
        /**
         * Gets products with category from database.
         * Update product stream
         */
        function searchForCategory() {
            var id = $(this).attr('id');
            alert(id);
        }

        function initSearchBox() {
            $("#search-bar").keyup(function(event){
                if(event.keyCode == 13){
                    //TODO: Enable search from database
                    let searchValue = $("#search-bar").val();

                    if(!searchValue){
                        // shake it
                        $("#search-bar").effect("shake", {times: 4, distance: 10}, 1000);
                        return;
                    }

                    requestProduct(searchValue, appendToProductStream);
                    //clear search bar value
                    $("#search-bar").val("");
                }
            });
        }
        function initShoppingList(){
            $("#shopping-list").draggable();
            $("#shopping-list").resizable({
                handles: 'n, e, s, w'
            });
            $("#shopping-list").droppable(
                {
                    accept: '.product',
                    over: dragObject

                }
            );

        }
        function initList() {
            $(".product").draggable({ revert: 'invalid' });

            $(".product").css("zIndex", 100);
        }
        /**
         * Handles what happens when user decides to add product to list.
         * Wish List/Shopping List UI is a list view. Is link to product.
         */
        function dragObject(event, ui){
            //$("#product").remove();

            let product = ui.draggable;

            let id = $(ui.draggable).attr("id");
            alert(id);

            ui.draggable.remove();
            //ui.draggable.remove();
            var item = "<li>The Product</li>";
            document.getElementById("list").innerHTML += item;
        }

        function appendProduct() {

        }
        /**
         * Filters products currently on stream by miles
         *
         *
         */
        function handleSliderValue(event, ui) {
            var miles = ui.value;
            alert(miles);
        }
        // Will dynamically generate search bar population with ajax from our database
        function initCompleteSearchBox(){
            $("#search-bar").keyup(function () {
                let val = $("#search-bar").val();
                requestAutoComplete(val, setCompleteSearchBox);
            });
        }
        // search input is an array
        function setCompleteSearchBox(searchInput){
            $("#search-bar").autocomplete({
                source: searchInput
            });
        }

        /**
         * Add productJSON to product stream
         */
        function appendToProductStream(productJSON){
            var unorderList = document.getElementById("products-list");
            // append to list
            // tester
            alert(productJSON.location);
        }
        /**
         * Dynamically centers product streams
         */
        function initProductSteamLocation() {
            $(window).resize(function(){
                $('#products').css({
                    position:'absolute',
                    left: ($(window).width() - $('#products').outerWidth())/2,
                    top: 70
                });
            });
        }
        $( function() {
            $( "#menu" ).menu();
        } );
        $( function() {
            $( document ).tooltip();
        } );
        function fetchPopupInfo(){
            requestProductPopup('tester', onPopUp);
        }
        /**
         * Enables pop up on background
         */
        function onPopUp(popupJSON) {
            $("#popup").toggle();
            $("#overLay").toggle();
            let addressJSON = popupJSON.address;
            displayLocation(addressJSON);
            // should be able to undo pop up
            enableRemovePopUp();
        }
        /**
         * Enable to hide pop up
         */
        function enableRemovePopUp() {
            let overlay = document.getElementById("overLay");
            /**
             * Disable pop up on background
             */
            overlay.onclick = function () {
                $("#popup").toggle();
                $("#overLay").toggle();
            }
        }

        function dropdownAnimateDown() {
            if(dropdownShowing){
                $('.dropdown-content').slideUp("medium");

            }else{
                $('.dropdown-content').slideDown("medium");
            }

            dropdownShowing = !dropdownShowing;
        }

        /**
         * Add a child to pop up
         */
        function addChildToPopup(aChild) {
            let popup = document.getElementById("popup");
            popup.appendChild(aChild);
        }
    </script>

</head>
<body>

<div class="mainBody">
    <div id="nav">
        <div id="nav-wrapper">
            <ul>
                <button onclick="dropdownAnimateDown();" class="nag-button">&#9776;</button>

                <li><a href="index.html">Home</a>
                </li>
                <li><a href="create-post.html">Post Something</a>
                </li>
                <button onclick="$('#shopping-list').toggle();" class="nag-button">Wish List</button>
                <input id="search-bar" name="search" type="text" placeholder="What are you looking for?">

                <li id="login"><a href="login.html">Login</a>
                </li>
                <li id="sign-out"><a onclick="onSignOut()">Sign Out</a>
                </li>

            </ul>
        </div>
    </div>

    <div class="dropdown-content">
        <ul id="dropdown-list">
            <li><a href="profile.html"> Profile </a></li>
            <li><a href="#"> Settings </a></li>
            <li><a href="posts/my-posts.html"> My Posts </a></li>
            <li><a href="about.html"> Want a job or contact us?</a></li>
        </ul>
    </div>


    <!-- Sidebar -->
    <div id="side-bar">
        <h3 class="categories">Categories</h3>
        <ul id="menu">
            <li><div class="category" id="rent"><span class="ui-icon ui-icon-tag"></span>Rent</div></li>
            <li><div class="category" id="free-stuff"><span class="ui-icon ui-icon-tag"></span>Free Stuff</div></li>
            <li><div class="category" id="sports"><span class="ui-icon ui-icon-tag"></span>Sports, Leisure and Games</div></li>
            <li><div class="category" id="home-and-garden"><span class="ui-icon ui-icon-tag"></span>Home and Garden</div></li>
            <li><div class="category" id="entertainment"><span class="ui-icon ui-icon-tag"></span>Movies, Books and Music</div></li>
            <li><div class="category" id="electronics"><span class="ui-icon ui-icon-tag"></span>Electronics</div></li>
            <li><div class="category" id="jobs"><span class="ui-icon ui-icon-tag"></span>Jobs</div></li>
            <li><div class="category" id="fashion"><span class="ui-icon ui-icon-tag"></span>Fashion</div></li>
            <li><div class="category" id="other"><span class="ui-icon ui-icon-tag"></span>Other</div></li>
        </ul>


        <p id="p-distance">Distance in Miles</p>
        <div id="slider"></div>

        <div id="slider-wrapper-label ">
            <label for="slider">1</label>
            <label for="slider" style="margin-left: 10em">50+ </label>
        </div>
    </div>

    <!--Dynamically stream products here by category-->
    <div id="products">
        <ul id="products-list">
            <li>
                <!-- All streams of products must be under class product-->

                <!-- This is not for UI. It is to hold reference-->
                <div id="4j34j43ijo34i5oj543io" class="product" onclick="fetchPopupInfo()">
                    <p>Product name</p>
                    <p>Product description</p>

                    <img src="test_images/couch.jpg" height="225" width="300">
                    <p>Location: the location</p>
                </div>
            </li>
        </ul>
    </div>
    <!-- Contains references to shopping list-->
    <div id="shopping-list">
        <p>Shopping List</p>
        <ul style="padding: 0px;" id="list">

        </ul>
    </div>

    <!--Enable a user to leave popup box when user clicks bg-->
    <div id="overLay"></div>
    <!-- The pop up container -->
    <div class="popupBox" id="popup">

        <!--Add information about product/service here-->
        <p id="title">Title of product</p>

        <!-- Description of Product Here -->
        <p id="description">
            Description of Product
        </p>

        <!-- Contact Here -->
        <p id="contact">
            Contact seller: <a href="mailto:example@sjsu.edu">Email</a>
        </p>


        <!-- Google Maps of product -->
        <div id="map" style="width: 200px;height:200px;background:none">
            <p>Loading...</p>
        </div>

    </div>


</div>

</body>
</html>